<template>
  <TLoader v-if="loading" />
  <div v-else-if="!exists" class="text-center">
    Event not found
  </div>
  <div v-else>
    <TPopup
      v-if="reservationPopup"
      title="Reserve a spot"
      @close="reservationPopup = false"
    >
      <div class="my-4 flex flex-col justify-center max-w-sm w-full">
        <div v-if="reservationPopup === 'reserve'">
          <div v-if="!uid" class="flex justify-center">
            <TButton type="secondary" class="my-2" to="/signin"
              >Sign In with WeDance</TButton
            >
          </div>
          <div v-if="!uid" class="divider">or</div>
          <div>
            <h2 v-if="!uid" class="font-bold">Register as Guest</h2>
            <p class="text-xs">
              Organiser of the event requires the following information:
            </p>
            <TForm
              v-model="account"
              :fields="reservationFields"
              submit-label="Reserve"
              class="mt-4"
              @save="reserve"
            />
          </div>
        </div>
        <div v-if="reservationPopup === 'finish'">
          <h2 class="font-bold mb-4">Your spot is reserved</h2>
          <p>
            You will receive a confirmation email during next 10 minutes. It
            might land into Spam folder. If you don't receive email please
            contact support@wedance.vip
          </p>
          <TButton type="primary" class="mt-4" @click="reservationPopup = false"
            >Finish</TButton
          >
        </div>
      </div>
    </TPopup>
    <div class="bg-dark text-real-white pt-16">
      <div class="mt-8 px-4 mx-auto max-w-2xl text-center">
        <TStyles :value="item.styles" />
        <h1 class="mt-4 text-4xl font-bold leading-tight">
          {{ item.name }}
        </h1>
        <p v-if="item.organiser" class="mt-2 text-xl">
          by {{ item.organiser }}
        </p>
        <div>
          <TButton
            v-if="!uid || item.response !== 'up'"
            class="mt-4 mr-4"
            type="danger"
            @click="reservationPopup = 'reserve'"
            >Reserve a spot</TButton
          >
          <TButton
            v-else
            class="mt-4 mr-4"
            type="success"
            @click="updateRsvp(item.id, 'events', 'down')"
            >You are going</TButton
          >
        </div>
        <div class="mt-8 pb-4">
          <p v-if="item.address">Address: {{ item.address }}</p>
          <p v-else>Online Event</p>
          <p v-if="item.price">Price: {{ item.price }}</p>
          <p>Start: {{ getDateTime(item.startDate) }}</p>
          <p>End: {{ getDateTime(item.endDate) }}</p>
        </div>
      </div>
    </div>
    <div class="mx-auto max-w-md">
      <div class="bg-white p-4">
        <div>
          <TPreview class="mt-2" :content="item.description" />

          <div v-if="can('edit', 'events', item)" class="my-2 flex items-start">
            <TButton
              icon="edit"
              :to="`/events/${item.id}/edit`"
              class="hover:text-blue-500"
              label="Edit"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import { computed, ref } from '@nuxtjs/composition-api'
import useAuth from '~/use/auth'
import useDoc from '~/use/doc'
import useRSVP from '~/use/rsvp'
import useRouter from '~/use/router'
import useProfiles from '~/use/profiles'
import useReactions from '~/use/reactions'
import useAccounts from '~/use/accounts'
import { getDateTime, dateDiff } from '~/utils'

export default {
  layout: 'public',
  data: () => ({
    comment: ''
  }),
  computed: {
    tweetUrl() {
      const app = process.env.app

      const url = app.url + this.$route.fullPath

      const text = encodeURI(`"${this.item.name}"`)

      return `https://twitter.com/intent/tweet?text=${text} %23WeDance ${url}`
    }
  },
  head() {
    if (!this.item) {
      return {}
    }

    const item = this.item

    return {
      title: item.title,
      meta: [
        {
          hid: 'description',
          name: 'description',
          content: item.excerpt
        },
        {
          name: 'keywords',
          content: item.keywords,
          hid: 'keywords'
        },
        {
          property: 'og:title',
          content: item.title,
          hid: 'og:title'
        },
        {
          property: 'og:description',
          content: item.excerpt,
          hid: 'og:description'
        }
      ]
    }
  },
  setup() {
    const { uid, can, account, updateAccount } = useAuth()
    const { params } = useRouter()
    const { getProfile } = useProfiles()
    const { accountFields } = useAccounts()

    const { doc, load, exists, loading } = useDoc('events')
    const { map } = useReactions()

    const { updateRsvp, createGuestRsvp } = useRSVP()

    if (params.id) {
      load(params.id)
    }

    const item = computed(() => map(doc.value))

    const reservationFields = accountFields

    const reservationPopup = ref(false)
    const isCreatingProfile = ref(false)

    const finishReservation = () => {
      reservationPopup.value = false
    }

    const reserve = async (participant) => {
      if (!uid.value) {
        createGuestRsvp(params.id, 'events', 'up', participant)
      } else {
        await updateAccount(participant)
        updateRsvp(params.id, 'events', 'up')
      }

      reservationPopup.value = 'finish'
    }

    return {
      isCreatingProfile,
      finishReservation,
      account,
      reservationPopup,
      reservationFields,
      reserve,
      exists,
      uid,
      loading,
      item,
      map,
      updateRsvp,
      can,
      getProfile,
      getDateTime,
      dateDiff
    }
  }
}
</script>
